# 第 6 章 Hook

## 6-2 保護資訊外洩的防線 – beforeSubmitPrompt Hook

### 在專案中建立 Hook

- 輸入的提示內容：
    ```md
    請在專案根目錄建立 .cursor/hooks.json 檔案，配置 beforeSubmitPrompt hook：
    - 執行命令：暫時不設定
    - 使用 Cursor 官方文件提供的 hook.json 格式：
    {
      "version": 1,
      "hooks": {
        "hook_type": [
          { 
            "command": "" 
          }
        ]
      }
    }
    ```

### 設計 Hook 觸發時要執行的指令 – 阻止送出敏感資訊

- 輸入的提示內容：
    ```md
    我已經在這個專案的 .cursor/hooks.json 中配置一個 beforeSubmitPrompt hook，但還未設計程式作為執行命令 command， 我希望這個程式能夠檢查使用者給的提示內容中是否包含敏感資訊(API Key、帳號密碼等) ，每當使用者將提示內容交給 Agent 就會自動執行，請根據以下要求設計程式：

    1.根據傳入的 JSON 資料取得提示內容，JSON 資料格式如下：
    {
      "conversation_id":"",
      "generation_id":"",
      "model":"",
      "prompt":"",
      "attachments":[],
      "hook_event_name":"beforeSubmitPrompt",
      "cursor_version":"",
      "workspace_roots":[ "" ],
      "user_email":XXXXX@gmail.com
    }

    2.檢查 JSON 資料 "prompt" 中的敏感資訊
    3.檢測到敏感資訊，輸出：{"continue": false, "user_message": "警告訊息"} 
    4.未發現敏感資訊時，輸出：{"continue": true} 
    5.由於 Cursor 傳遞的是 UTF-8 編碼的 JSON 資料，程式需要正確的處理編碼。
    6.這個程式不要放到 .cursor 中，這樣 hook 才能順利生效。
    7.我是用 uv 工具來管理專案, 所以請使用 "uv run python 腳本名稱.py" 來執行腳本。
    ```

- [6-2 範例程式](https://github.com/FlagTech/F6722_ch06_02)

    ```md
    https://github.com/FlagTech/F6722_ch06_02.git
    ```

## 6-3 建立 beforeReadFile Hook – 阻止 Agent 讀取特定檔案

### 新增第二個 Hook

- 輸入的提示內容：
    ```md
    請在專案根目錄建立 .cursor/hooks.json 檔案，配置 beforeReadFile hook：
    - 檢查 .cursor/hooks.json 是否已經存在，如果有就沿用舊檔添加 beforeReadFile hook
    - 執行命令：暫時不設定
    - 使用標準 Cursor Hook JSON 格式：
    {
      "version": 1,
      "hooks": {
        "hook_type": [
          { 
            "command": "" 
          }
        ]
      }
    }
    ```

### Hook 觸發時要執行的指令 – 保護重要檔案不被 Agent 讀取

- 輸入的提示內容：
    ```md
    我已經在這個專案的 .cursor/hooks.json 配置一個 beforeReadFile hook，但還未設計程式作為執行命令 command，請依照我的要求設計出這個 Python 程式並配置：

    我希望這個程式能夠在 Agent 要讀取敏感檔案前阻止，每當 Agent 讀取檔案前，就會根據 Cursor 傳入的 JSON 資料的檔案路徑取得檔案名稱，並自動與敏感檔案名單比對，程式需要：

    1.根據傳入的 JSON 資料的檔案路徑取得檔案名稱，JSON 資料格式如下：
    {
      "conversation_id": "",
      "generation_id": "",
      "model": "",
      "content": "",
      "file_path": "",
      "attachments": [],
      "hook_event_name": "beforeReadFile",
      "cursor_version": "",
      "workspace_roots": [],
      "user_email": "XXXXX@gmail.com"
    }

    2.檢查 JSON 資料 "file_path" 中的檔名並與敏感檔案名單比對
    3.如果要讀取的檔案在敏感檔案名單中，輸出：{ "permission": "deny", "user_message": "警告訊息"} 
    4.要讀取的檔案不是敏感檔案時，輸出：{"permission": "allow"} 
    5.由於 Cursor 傳遞的是 UTF-8 編碼的 JSON 資料，程式需要正確的處理編碼。
    6.我是用 uv 工具來管理專案, 所以請使用 "uv run python 腳本名稱.py" 來執行腳本。
    ```

- [6-3 範例程式](https://github.com/FlagTech/F6722_ch06_03)

    ```md
    https://github.com/FlagTech/F6722_ch06_03.git
    ```

## 6-4 建立 Stop Hook – 在 LINE 上收到提醒通知

### 新增最後一個 Hook

- 輸入的提示內容：
    ```md
    請在專案根目錄建立 .cursor/hooks.json 檔案，配置 stop hook：
    - 檢查 .cursor/hooks.json 是否已經存在，如果有就沿用舊檔添加 stop hook
    - 執行命令：暫時不設定
    - 使用標準 Cursor Hook JSON 格式：
    {
      "version": 1,
      "hooks": {
        "hook_type": [
          { 
            "command": "" 
          }
        ]
      }
    }
    ```

### Hook 觸發時要執行的指令 – 發送提醒通知到 LINE

- 輸入的提示內容：
    ```md
    我已經在這個專案的 .cursor/hooks.json 配置一個 stop hook，但還未設計程式作為執行命令 command，請依照我的要求設計出這個 Python 程式並配置：

    我希望這個程式能夠在 Agent 終止時發送 LINE 通知，每當 Agent 終止，就會依據終止狀態，傳送對應的 LINE 通知，程式需要：

    1.根據傳入的 JSON 資料取得終止狀態內容，JSON 資料格式如下：
    {
      "conversation_id": "",
      "generation_id": "",
      "model": "",
      "status": "completed",
      "loop_count": 0,
      "hook_event_name": "stop",
      "cursor_version": "",
      "workspace_roots": [ "" ],
      "user_email": "XXXXX@gmail.com"
    }
    2.根據 JSON 資料的 "status" 建立不同訊息
    3.使用 LINE Messaging API 發送通知，並從 .env 讀取環境變數，不要使用 LINE Notify API 
    4.我已經擁有 LINE Channel Access Token 與 User ID，只須建立 .env 檔案來儲存 LINE 設定
    5.由於 Cursor 傳遞的是 UTF-8 編碼的 JSON 資料，程式需要正確的處理編碼
    6.我是用 uv 工具來管理專案，所以請使用 "uv run python 腳本名稱.py" 來執行腳本。
    ```

- [6-4 範例程式](https://github.com/FlagTech/F6722_ch06_04)

    ```md
    https://github.com/FlagTech/F6722_ch06_04.git
    ```
